<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng Quản Trị - Quản Lý Đăng Ký</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/admin/admin-panel.css}">
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<style>
    /* ==== Global Reset and Base Styling ==== */
    html, body {
        height: 100%;
        margin: 0;
        padding: 0;
        font-family: 'Segoe UI', sans-serif;
        background: #f9f9f9;
    }

    .wrapper {
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    /* ==== Header ==== */
    header {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 60px;
        background: #fff;
        color: #111;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 24px;
        z-index: 1000;
        border-bottom: 1px solid #e0e0e0;
    }

    .menu-toggle {
        cursor: pointer;
    }

    /* User Info */
    .user-info {
        position: relative;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .user-info i {
        font-size: 18px;
        color: #333;
    }

    /* Logout Dropdown */
    .logout-dropdown {
        display: none;
        position: absolute;
        top: 100%;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 4px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        z-index: 1000;
        min-width: 120px;
        margin-top: 5px;
    }

    .logout-dropdown button {
        border: none;
        background: none;
        width: 100%;
        padding: 8px 12px;
        text-align: left;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .logout-dropdown button:hover {
        background-color: #f8f9fa;
    }

    /* ==== Sidebar ==== */
    .sidebar {
        background: #111;
        color: white;
        width: 240px;
        height: 100vh;
        padding: 90px 20px 30px;
        position: fixed;
        top: 0;
        left: 0;
        overflow-y: auto;
        z-index: 999;
        display: none;
    }

    .sidebar.show {
        display: block;
    }

    .sidebar h4 {
        font-size: 16px;
        margin-bottom: 24px;
        color: #bbb;
        letter-spacing: 0.5px;
    }

    .sidebar a {
        display: block;
        color: white;
        text-decoration: none;
        margin-bottom: 12px;
        font-size: 15px;
        padding: 10px 16px;
        border-radius: 8px;
        transition: all 0.2s ease;
    }

    .sidebar a:hover {
        background-color: #f1f1f1;
        color: #111;
        transform: translateX(4px);
    }

    /* ==== Main Content ==== */
    .main-content {
        margin-left: 0;
        padding: 100px 40px 40px;
        flex-grow: 1;
        background: #f9f9f9;
        transition: margin-left 0.3s ease;
    }

    .sidebar.show ~ .main-content {
        margin-left: 240px;
    }

    .main-content h2 {
        margin-bottom: 30px;
        color: #111;
    }

    /* Grid */


    .grid-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 24px;
    }


    .card {
        background: #fff;
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.04);
        border: 1px solid #e5e5e5;
        transition: all 0.2s ease;
    }

    .card:hover {
        box-shadow: 0 6px 14px rgba(0,0,0,0.08);
        transform: translateY(-4px);
    }

    .card h5 {
        font-size: 16px;
        font-weight: 600;
        color: #111;
        margin-bottom: 8px;
    }

    .card p {
        font-size: 14px;
        color: #555;
    }

    /* ==== Footer ==== */
    footer {
        background: #fff;
        color: #888;
        text-align: center;
        padding: 12px 20px;
        font-size: 13px;
        border-top: 1px solid #e0e0e0;
        margin-top: auto;
    }

    @media (min-width: 769px) {
        .sidebar.show ~ .main-content + footer {
            margin-left: 240px;
        }
    }

    @media (max-width: 768px) {
        .main-content {
            padding: 100px 20px 40px;
        }
    }

</style>
<body>
<div class="wrapper">
    <!-- Header -->
    <header>
        <div class="menu-toggle" onclick="toggleSidebar()">
            <i class="fas fa-bars" id="menuIcon"></i>
        </div>
        <div class="user-info">
            <i class="fas fa-user me-2" onclick="toggleLogoutDropdown()"></i>
            <div id="logoutDropdown" class="logout-dropdown">
                <form th:action="@{/logout}" method="post">
                    <button type="submit" class="btn btn-sm btn-outline-danger w-100">Logout</button>
                </form>
            </div>
        </div>
    </header>

    <div class="sidebar" id="sidebar">
        <a th:href="@{/admin/panel}" class="sidebar-link home-link">
            <i class="bi bi-house-door-fill"></i>Trang chủ
        </a>
        <a th:href="@{/admin/info}"><i class="fas fa-user me-2"></i>Tài khoản</a>
        <a th:href="@{/subjects}"><i class="fas fa-book me-2"></i>Môn học</a>
        <a th:href="@{/classes}"><i class="fas fa-chalkboard me-2"></i>Lớp học</a>
        <a th:href="@{/admin/grades}"><i class="fas fa-id-badge me-2"></i>Điểm số</a>
        <a th:href="@{/admin/schedules}" class="sidebar-link active"><i class="fas fa-calendar-alt me-2"></i>Lịch học</a>
        <a th:href="@{/admin/registrations}" class="sidebar-link active"><i class="fas fa-user-plus me-2"></i>Đăng ký</a>
    </div>

    <div class="main-content">
        <!-- Success/Error Messages -->
        <div th:if="${message}" class="alert alert-success mb-4 p-4 bg-green-100 border-l-4 border-green-500 text-green-700 rounded">
            <div class="flex items-center">
                <i class="fas fa-check-circle mr-2"></i>
                <span th:text="${message}"></span>
            </div>
        </div>

        <div th:if="${error}" class="alert alert-error mb-4 p-4 bg-red-100 border-l-4 border-red-500 text-red-700 rounded">
            <div class="flex items-center">
                <i class="fas fa-exclamation-circle mr-2"></i>
                <span th:text="${error}"></span>
            </div>
        </div>

        <!-- Page Header -->
        <div class="page-header mb-6">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="page-title">
                        <i class="fas fa-user-plus me-3"></i>Quản Lý Đăng Ký
                    </h1>
                    <p class="text-muted">Quản lý đăng ký môn học của sinh viên</p>
                </div>
                <div>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addRegistrationModal">
                        <i class="fas fa-plus me-2"></i>Thêm Đăng Ký
                    </button>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-primary text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h5 class="card-title">Tổng Đăng Ký</h5>
                                <h2 th:text="${totalRegistrations ?: 0}">0</h2>
                            </div>
                            <div class="card-icon">
                                <i class="fas fa-clipboard-list fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h5 class="card-title">Đã Chấp Nhận</h5>
                                <h2 th:text="${approvedRegistrations ?: 0}">0</h2>
                            </div>
                            <div class="card-icon">
                                <i class="fas fa-check-circle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h5 class="card-title">Chờ Duyệt</h5>
                                <h2 th:text="${pendingRegistrations ?: 0}">0</h2>
                            </div>
                            <div class="card-icon">
                                <i class="fas fa-clock fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <h5 class="card-title">Bị Từ Chối</h5>
                                <h2 th:text="${rejectedRegistrations ?: 0}">0</h2>
                            </div>
                            <div class="card-icon">
                                <i class="fas fa-times-circle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-body">
                <form method="get" th:action="@{/admin/registrations}">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="studentSearch" class="form-label">Tìm Sinh Viên</label>
                            <input type="text" class="form-control" id="studentSearch" name="studentSearch"
                                   th:value="${studentSearch}" placeholder="Tên hoặc mã sinh viên...">
                        </div>
                        <div class="col-md-3">
                            <label for="classFilter" class="form-label">Lớp Học</label>
                            <select class="form-select" id="classFilter" name="classId">
                                <option value="">Tất cả lớp</option>
                                <option th:each="clazz : ${classes}"
                                        th:value="${clazz.id}"
                                        th:text="${clazz.name}"
                                        th:selected="${clazz.id == classId}">
                                    Class Name
                                </option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="statusFilter" class="form-label">Trạng Thái</label>
                            <select class="form-select" id="statusFilter" name="status">
                                <option value="">Tất cả trạng thái</option>
                                <option value="REGISTERED" th:selected="${status == 'REGISTERED'}">Đã Đăng Ký</option>
                                <option value="APPROVED" th:selected="${status == 'APPROVED'}">Đã Chấp Nhận</option>
                                <option value="REJECTED" th:selected="${status == 'REJECTED'}">Bị Từ Chối</option>
                                <option value="CANCELLED" th:selected="${status == 'CANCELLED'}">Đã Hủy</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-search me-1"></i>Tìm Kiếm
                            </button>
                            <a th:href="@{/admin/registrations}" class="btn btn-secondary">
                                <i class="fas fa-undo me-1"></i>Reset
                            </a>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Registrations Table -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list me-2"></i>Danh Sách Đăng Ký
                </h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-dark">
                        <tr>
                            <th>ID</th>
                            <th>Sinh Viên</th>
                            <th>Lớp Học</th>
                            <th>Môn Học</th>
                            <th>Ngày Đăng Ký</th>
                            <th>Trạng Thái</th>
                            <th>Ghi Chú</th>
                            <th>Thao Tác</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="registration : ${registrations}">
                            <td th:text="${registration.id}">1</td>
                            <td>
                                <div>
                                    <strong th:text="${registration.student?.fullName}">Student Name</strong>
                                    <br>
                                    <small class="text-muted" th:text="${registration.student?.username}">student_code</small>
                                </div>
                            </td>
                            <td>
                                <span class="badge bg-info" th:text="${registration.classEntity?.name}">Class Name</span>
                            </td>
                            <td>
                                <span th:text="${registration.subject?.name}">Subject Name</span>
                                <br>
                                <small class="text-muted" th:text="${registration.subject?.credits + ' tín chỉ'}">3 tín chỉ</small>
                            </td>
                            <td th:text="${#temporals.format(registration.registeredAt, 'dd/MM/yyyy HH:mm')}">01/01/2024 10:00</td>
                            <td>
                                    <span class="badge"
                                          th:class="${registration.status == 'APPROVED'} ? 'bg-success' :
                                                    (${registration.status == 'REJECTED'} ? 'bg-danger' :
                                                    (${registration.status == 'CANCELLED'} ? 'bg-secondary' : 'bg-warning'))"
                                          th:text="${registration.status == 'REGISTERED'} ? 'Đã Đăng Ký' :
                                                   (${registration.status == 'APPROVED'} ? 'Đã Chấp Nhận' :
                                                   (${registration.status == 'REJECTED'} ? 'Bị Từ Chối' : 'Đã Hủy'))">
                                        Status
                                    </span>
                            </td>
                            <td>
                                <span th:text="${registration.notes}" class="text-truncate" style="max-width: 100px;">Notes</span>
                            </td>
                            <td>
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-success"
                                            th:if="${registration.status == 'REGISTERED'}"
                                            th:onclick="'approveRegistration(' + ${registration.id} + ')'">
                                        <i class="fas fa-check"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger"
                                            th:if="${registration.status == 'REGISTERED'}"
                                            th:onclick="'rejectRegistration(' + ${registration.id} + ')'">
                                        <i class="fas fa-times"></i>
                                    </button>
                                    <button class="btn btn-sm btn-info"
                                            th:onclick="'viewRegistrationDetails(' + ${registration.id} + ')'">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="btn btn-sm btn-danger"
                                            th:onclick="'deleteRegistration(' + ${registration.id} + ')'">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <tr th:if="${#lists.isEmpty(registrations)}">
                            <td colspan="8" class="text-center text-muted py-4">
                                <i class="fas fa-inbox fa-2x mb-2"></i>
                                <br>Không có dữ liệu đăng ký
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Pagination -->
                <div th:if="${totalPages > 1}" class="d-flex justify-content-center mt-4">
                    <nav aria-label="Page navigation">
                        <ul class="pagination">
                            <li class="page-item" th:class="${currentPage == 0} ? 'disabled'">
                                <a class="page-link" th:href="@{/admin/registrations(page=${currentPage - 1}, studentSearch=${studentSearch}, classId=${classId}, status=${status})}">Previous</a>
                            </li>
                            <li th:each="i : ${#numbers.sequence(0, totalPages - 1)}"
                                class="page-item" th:class="${i == currentPage} ? 'active'">
                                <a class="page-link" th:href="@{/admin/registrations(page=${i}, studentSearch=${studentSearch}, classId=${classId}, status=${status})}" th:text="${i + 1}">1</a>
                            </li>
                            <li class="page-item" th:class="${currentPage == totalPages - 1} ? 'disabled'">
                                <a class="page-link" th:href="@{/admin/registrations(page=${currentPage + 1}, studentSearch=${studentSearch}, classId=${classId}, status=${status})}">Next</a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Registration Modal -->
<div class="modal fade" id="addRegistrationModal" tabindex="-1" aria-labelledby="addRegistrationModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addRegistrationModalLabel">
                    <i class="fas fa-plus me-2"></i>Thêm Đăng Ký Mới
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form th:action="@{/admin/registrations/add}" method="post">
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="studentId" class="form-label">Sinh Viên *</label>
                            <select class="form-select" id="studentId" name="studentId" required>
                                <option value="">Chọn sinh viên...</option>
                                <option th:each="student : ${students}"
                                        th:value="${student.id}"
                                        th:text="${student.fullName + ' (' + student.username + ')'}">
                                    Student Name (student_code)
                                </option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="subjectId" class="form-label">Môn Học *</label>
                            <select class="form-select" id="subjectId" name="subjectId" required>
                                <option value="">Chọn môn học...</option>
                                <option th:each="subject : ${subjects}"
                                        th:value="${subject.id}"
                                        th:text="${subject.name + ' (' + subject.credits + ' tín chỉ)'}">
                                    Subject Name (3 tín chỉ)
                                </option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-6">
                            <label for="classIdModal" class="form-label">Lớp Học</label>
                            <select class="form-select" id="classIdModal" name="classId">
                                <option value="">Chọn lớp học...</option>
                                <option th:each="clazz : ${classes}"
                                        th:value="${clazz.id}"
                                        th:text="${clazz.name}">
                                    Class Name
                                </option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="statusModal" class="form-label">Trạng Thái</label>
                            <select class="form-select" id="statusModal" name="status">
                                <option value="REGISTERED">Đã Đăng Ký</option>
                                <option value="APPROVED">Đã Chấp Nhận</option>
                                <option value="REJECTED">Bị Từ Chối</option>
                                <option value="CANCELLED">Đã Hủy</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-3">
                        <label for="notesModal" class="form-label">Ghi Chú</label>
                        <textarea class="form-control" id="notesModal" name="notes" rows="3"
                                  placeholder="Nhập ghi chú (không bắt buộc)..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save me-1"></i>Lưu Đăng Ký
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<footer>
    © 2025 Hệ thống Quản lý Sinh viên. All rights reserved.
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:src="@{/js/admin-schedules.js}"></script>
<script>
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const menuIcon = document.getElementById('menuIcon');
        sidebar.classList.toggle('show');

        if (sidebar.classList.contains('show')) {
            menuIcon.classList.remove('fa-bars');
            menuIcon.classList.add('fa-bars');
        } else {
            menuIcon.classList.remove('fa-bars');
            menuIcon.classList.add('fa-bars');
        }
    }

    function toggleLogoutDropdown() {
        const dropdown = document.getElementById('logoutDropdown');
        dropdown.classList.toggle('show');
    }

    function approveRegistration(id) {
        if (confirm('Bạn có chắc chắn muốn chấp nhận đăng ký này?')) {
            fetch(`/admin/registrations/${id}/approve`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Có lỗi xảy ra khi chấp nhận đăng ký!');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi chấp nhận đăng ký!');
                });
        }
    }

    function rejectRegistration(id) {
        const reason = prompt('Nhập lý do từ chối (không bắt buộc):');
        if (reason !== null) {
            fetch(`/admin/registrations/${id}/reject`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ reason: reason })
            })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Có lỗi xảy ra khi từ chối đăng ký!');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi từ chối đăng ký!');
                });
        }
    }

    function viewRegistrationDetails(id) {
        // TODO: Implement view details modal
        alert('Tính năng xem chi tiết đang được phát triển!');
    }

    function deleteRegistration(id) {
        if (confirm('Bạn có chắc chắn muốn xóa đăng ký này? Hành động này không thể hoàn tác!')) {
            fetch(`/admin/registrations/${id}/delete`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Có lỗi xảy ra khi xóa đăng ký!');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi xóa đăng ký!');
                });
        }
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        const dropdown = document.getElementById('logoutDropdown');
        const userInfo = document.querySelector('.user-info');

        if (!userInfo.contains(event.target)) {
            dropdown.classList.remove('show');
        }
    });
</script>
</body>
</html>
