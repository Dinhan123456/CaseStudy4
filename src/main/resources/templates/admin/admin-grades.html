<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bảng Quản Trị</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" th:href="@{/admin/admin-panel.css}">

</head>
<body>
<div class="wrapper">
    <header>
        <div class="menu-toggle" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </div>
        <div class="user-info">
            <i class="fas fa-user me-2" onclick="toggleLogoutDropdown()"></i>

            <div id="logoutDropdown" class="logout-dropdown">
                <form th:action="@{/logout}" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <button type="submit" class="btn btn-sm btn-outline-danger w-100">Logout</button>
                </form>
            </div>
        </div>
    </header>

    <div class="sidebar" id="sidebar">
        <a th:href="@{/admin/panel}" class="sidebar-link home-link">
            <i class="bi bi-house-door-fill"></i>Trang chủ
        </a>
        <a th:href="@{/admin/info}"><i class="fas fa-user me-2"></i>Tài khoản</a>
        <a th:href="@{/subjects}"><i class="fas fa-book me-2"></i>Môn học</a>
        <a th:href="@{/classes}"><i class="fas fa-chalkboard me-2"></i>Lớp học</a>
        <a th:href="@{/admin/grades}"><i class="fas fa-id-badge me-2"></i>Điểm số</a>
        <a th:href="@{/admin/schedules}" class="sidebar-link active"><i class="fas fa-calendar-alt me-2"></i>Lịch học</a>
        <a th:href="@{/admin/registrations}" class="sidebar-link active"><i class="fas fa-user-plus me-2"></i>Đăng ký</a>
    </div>

    <div class="main-content">
        <div class="container-fluid">
            <div class="row">
                <div class="col-12">
                    <h2 class="mb-4">
                        <i class="fas fa-chart-line me-2"></i>Quản lý điểm số sinh viên
                    </h2>

                    <!-- Cấu hình tỷ lệ điểm -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5><i class="fas fa-cogs me-2"></i>Cấu hình tỷ lệ điểm</h5>
                            <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#configGradeModal">
                                <i class="fas fa-edit"></i> Chỉnh sửa tỷ lệ
                            </button>
                        </div>
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-md-3">
                                    <div class="grade-config-item">
                                        <h6>Điểm 15 phút</h6>
                                        <span class="badge bg-info fs-6" id="percent15">5%</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="grade-config-item">
                                        <h6>Điểm giữa kỳ</h6>
                                        <span class="badge bg-warning fs-6" id="percentMidterm">20%</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="grade-config-item">
                                        <h6>Điểm chuyên cần</h6>
                                        <span class="badge bg-success fs-6" id="percentAttendance">5%</span>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="grade-config-item">
                                        <h6>Điểm thi cuối kỳ</h6>
                                        <span class="badge bg-danger fs-6" id="percentFinal">70%</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bộ lọc và tìm kiếm -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label for="classFilter" class="form-label">Lớp học</label>
                                    <select class="form-select" id="classFilter" onchange="loadGradesByClass()">
                                        <option value="">-- Chọn lớp học --</option>
                                        <option th:each="class : ${classes}"
                                                th:value="${class.id}"
                                                th:text="${class.name}">
                                        </option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="subjectFilter" class="form-label">Môn học</label>
                                    <select class="form-select" id="subjectFilter" onchange="loadGradesBySubject()">
                                        <option value="">-- Chọn môn học --</option>
                                        <option th:each="subject : ${subjects}"
                                                th:value="${subject.id}"
                                                th:text="${subject.name}">
                                        </option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="studentSearch" class="form-label">Tìm kiếm sinh viên</label>
                                    <input type="text" class="form-control" id="studentSearch"
                                           placeholder="Nhập tên hoặc email sinh viên..."
                                           onkeyup="searchStudents()">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Bảng điểm -->
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5><i class="fas fa-table me-2"></i>Bảng điểm chi tiết</h5>
                            <div>
                                <button class="btn btn-success btn-sm me-2" onclick="addGrade()">
                                    <i class="fas fa-plus"></i> Thêm điểm
                                </button>
                                <button class="btn btn-info btn-sm" onclick="exportGrades()">
                                    <i class="fas fa-download"></i> Xuất Excel
                                </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped table-hover" id="gradesTable">
                                    <thead class="table-dark">
                                        <tr>
                                            <th rowspan="2">STT</th>
                                            <th rowspan="2">Sinh viên</th>
                                            <th rowspan="2">Lớp</th>
                                            <th rowspan="2">Môn học</th>
                                            <th colspan="4" class="text-center">Điểm thành phần</th>
                                            <th rowspan="2">Điểm TB (10)</th>
                                            <th rowspan="2">Điểm TB (4)</th>
                                            <th rowspan="2">Xếp hạng</th>
                                            <th rowspan="2">Hành động</th>
                                        </tr>
                                        <tr>
                                            <th>15 phút (5%)</th>
                                            <th>Giữa kỳ (20%)</th>
                                            <th>Chuyên cần (5%)</th>
                                            <th>Cuối kỳ (70%)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="gradesTableBody">
                                        <!-- Dữ liệu sẽ được load bằng JavaScript -->
                                        <tr>
                                            <td colspan="12" class="text-center text-muted py-4">
                                                Vui lòng chọn lớp học hoặc môn học để xem điểm
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Thống kê -->
                    <div class="row mt-4">
                        <div class="col-md-3">
                            <div class="card bg-primary text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6>Hạng A</h6>
                                            <h3 id="gradeA">0</h3>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-medal fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-success text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6>Hạng B</h6>
                                            <h3 id="gradeB">0</h3>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-trophy fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-warning text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6>Hạng C</h6>
                                            <h3 id="gradeC">0</h3>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-award fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card bg-danger text-white">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between">
                                        <div>
                                            <h6>Hạng D+F</h6>
                                            <h3 id="gradeDandF">0</h3>
                                        </div>
                                        <div class="align-self-center">
                                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        © 2025 Hệ thống Quản lý Sinh viên. All rights reserved.
    </footer>
</div>
<!-- Modal cấu hình tỷ lệ điểm -->
<div class="modal fade" id="configGradeModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cấu hình tỷ lệ điểm</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="gradeConfigForm">
                    <div class="mb-3">
                        <label for="percent15Input" class="form-label">Điểm 15 phút (%)</label>
                        <input type="number" class="form-control" id="percent15Input" value="5" min="0" max="100">
                    </div>
                    <div class="mb-3">
                        <label for="percentMidtermInput" class="form-label">Điểm giữa kỳ (%)</label>
                        <input type="number" class="form-control" id="percentMidtermInput" value="20" min="0" max="100">
                    </div>
                    <div class="mb-3">
                        <label for="percentAttendanceInput" class="form-label">Điểm chuyên cần (%)</label>
                        <input type="number" class="form-control" id="percentAttendanceInput" value="5" min="0" max="100">
                    </div>
                    <div class="mb-3">
                        <label for="percentFinalInput" class="form-label">Điểm thi cuối kỳ (%)</label>
                        <input type="number" class="form-control" id="percentFinalInput" value="70" min="0" max="100">
                    </div>
                    <div class="alert alert-info">
                        <small>Tổng tỷ lệ phải bằng 100%. Hiện tại: <span id="totalPercent">100%</span></small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="saveGradeConfig()">Lưu cấu hình</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal thêm/sửa điểm -->
<div class="modal fade" id="gradeModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="gradeModalTitle">Thêm điểm mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="gradeForm" th:action="@{/admin/grades/save}" method="post">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                    <input type="hidden" id="gradeId" name="gradeId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="studentSelect" class="form-label">Sinh viên</label>
                                <select class="form-select" id="studentSelect" required>
                                    <option value="">-- Chọn sinh viên --</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="subjectSelect" class="form-label">Môn học</label>
                                <select class="form-select" id="subjectSelect" required>
                                    <option value="">-- Chọn môn học --</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="grade15" class="form-label">Điểm 15 phút</label>
                                <input type="number" class="form-control grade-input" id="grade15"
                                       min="0" max="10" step="0.1" onchange="calculateAverageGrade()">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="gradeMidterm" class="form-label">Điểm giữa kỳ</label>
                                <input type="number" class="form-control grade-input" id="gradeMidterm"
                                       min="0" max="10" step="0.1" onchange="calculateAverageGrade()">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="gradeAttendance" class="form-label">Điểm chuyên cần</label>
                                <input type="number" class="form-control grade-input" id="gradeAttendance"
                                       min="0" max="10" step="0.1" onchange="calculateAverageGrade()">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label for="gradeFinal" class="form-label">Điểm cuối kỳ</label>
                                <input type="number" class="form-control grade-input" id="gradeFinal"
                                       min="0" max="10" step="0.1" onchange="calculateAverageGrade()">
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Điểm TB (Thang 10)</label>
                                <input type="text" class="form-control" id="averageGrade10" readonly>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Điểm TB (Thang 4)</label>
                                <input type="text" class="form-control" id="averageGrade4" readonly>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">Xếp hạng</label>
                                <input type="text" class="form-control" id="gradeRank" readonly>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="saveGrade()">Lưu điểm</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    function toggleLogoutDropdown() {
        const dropdown = document.getElementById("logoutDropdown");
        if (dropdown) {
            dropdown.style.display = (dropdown.style.display === "block") ? "none" : "block";
        }
    }

    function toggleSidebar() {
        const sidebar = document.getElementById("sidebar");
        if (sidebar) {
            sidebar.classList.toggle("show");
        }
    }

    document.addEventListener("click", function (event) {
        const userInfo = document.querySelector(".user-info");
        const dropdown = document.getElementById("logoutDropdown");
        const sidebar = document.getElementById("sidebar");
        const toggle = document.querySelector(".menu-toggle");

        if (dropdown && userInfo && !userInfo.contains(event.target)) {
            dropdown.style.display = "none";
        }

        if (sidebar && !sidebar.contains(event.target) && !toggle.contains(event.target)) {
            sidebar.classList.remove("show");
        }
    });


// Cấu hình tỷ lệ điểm mặc định
let gradeConfig = {
    percent15: 5,
    percentMidterm: 20,
    percentAttendance: 5,
    percentFinal: 70
};

// Dữ liệu mẫu
let gradesData = [];
let studentsData = [];
let subjectsData = [];
let classesData = [];

// Khởi tạo trang
document.addEventListener('DOMContentLoaded', function() {
    loadInitialData();
    updatePercentageInputs();
});

// Tải dữ liệu ban đầu
function loadInitialData() {
    // Gọi API để lấy dữ liệu thật từ database
    fetch('/api/users/students')
        .then(response => response.json())
        .then(students => {
            studentsData = students.map(student => ({
                id: student.id,
                name: student.fullName,
                email: student.email,
                className: student.classEntity ? student.classEntity.name : 'Chưa phân lớp'
            }));
            populateSelects();
        })
        .catch(error => {
            console.error('Lỗi khi tải danh sách sinh viên:', error);
            // Fallback: dùng dữ liệu mẫu nếu API lỗi
            studentsData = [
                {id: 1, name: 'Nguyễn Văn A', email: 'a@email.com', className: 'Java01'},
                {id: 2, name: 'Trần Thị B', email: 'b@email.com', className: 'Java01'},
                {id: 3, name: 'Lê Văn C', email: 'c@email.com', className: 'Java02'}
            ];
            populateSelects();
        });

    fetch('/api/subjects')
        .then(response => response.json())
        .then(subjects => {
            subjectsData = subjects.map(subject => ({
                id: subject.id,
                name: subject.name,
                credits: subject.credits
            }));
            populateSelects();
        })
        .catch(error => {
            console.error('Lỗi khi tải danh sách môn học:', error);
            // Fallback: dùng dữ liệu mẫu nếu API lỗi
            subjectsData = [
                {id: 1, name: 'Java Programming', credits: 3},
                {id: 2, name: 'Database Design', credits: 2},
                {id: 3, name: 'Web Development', credits: 4}
            ];
            populateSelects();
        });

    fetch('/api/classes')
        .then(response => response.json())
        .then(classes => {
            classesData = classes.map(cls => ({
                id: cls.id,
                name: cls.name
            }));
            populateSelects();
        })
        .catch(error => {
            console.error('Lỗi khi tải danh sách lớp học:', error);
            // Fallback: dùng dữ liệu mẫu nếu API lỗi
            classesData = [
                {id: 1, name: 'Java01'},
                {id: 2, name: 'Java02'}
            ];
            populateSelects();
        });

    // Tải tất cả điểm từ database
    loadAllGrades();
}

// Tải tất cả điểm từ database
function loadAllGrades() {
    fetch('/api/grades')
        .then(response => response.json())
        .then(grades => {
            gradesData = grades.map(grade => ({
                id: grade.id,
                studentId: grade.student.id,
                studentName: grade.student.fullName,
                className: grade.classEntity ? grade.classEntity.name : 'Chưa phân lớp',
                subjectId: grade.subject.id,
                subjectName: grade.subject.name,
                grade15: grade.grade15,
                gradeMidterm: grade.gradeMidterm,
                gradeAttendance: grade.gradeAttendance,
                gradeFinal: grade.gradeFinal,
                averageGrade: grade.averageGrade,
                gradeRank: grade.gradeRank
            }));
            displayGrades(gradesData);
        })
        .catch(error => {
            console.error('Lỗi khi tải điểm:', error);
            // Fallback: dùng dữ liệu mẫu nếu API lỗi
            gradesData = [
                {
                    id: 1, studentId: 1, studentName: 'Nguyễn Văn A', className: 'Java01',
                    subjectId: 1, subjectName: 'Java Programming',
                    grade15: 8.5, gradeMidterm: 7.8, gradeAttendance: 9.0, gradeFinal: 8.2
                },
                {
                    id: 2, studentId: 2, studentName: 'Trần Thị B', className: 'Java01',
                    subjectId: 1, subjectName: 'Java Programming',
                    grade15: 7.2, gradeMidterm: 8.5, gradeAttendance: 8.5, gradeFinal: 7.8
                }
            ];
            displayGrades(gradesData);
        });
}

// Điền dữ liệu vào các select box
function populateSelects() {
    const classFilter = document.getElementById('classFilter');
    const subjectFilter = document.getElementById('subjectFilter');
    const studentSelect = document.getElementById('studentSelect');
    const subjectSelect = document.getElementById('subjectSelect');

    // Điền lớp học
    classFilter.innerHTML = '<option value="">-- Chọn lớp học --</option>';
    classesData.forEach(cls => {
        classFilter.innerHTML += `<option value="${cls.id}">${cls.name}</option>`;
    });

    // Điền môn học
    subjectFilter.innerHTML = '<option value="">-- Chọn môn học --</option>';
    subjectsData.forEach(subject => {
        subjectFilter.innerHTML += `<option value="${subject.id}">${subject.name}</option>`;
    });

    // Điền sinh viên trong modal
    studentSelect.innerHTML = '<option value="">-- Chọn sinh viên --</option>';
    studentsData.forEach(student => {
        studentSelect.innerHTML += `<option value="${student.id}">${student.name} (${student.className})</option>`;
    });

    // Điền môn học trong modal
    subjectSelect.innerHTML = '<option value="">-- Chọn môn học --</option>';
    subjectsData.forEach(subject => {
        subjectSelect.innerHTML += `<option value="${subject.id}">${subject.name}</option>`;
    });
}

// Tải điểm theo lớp
function loadGradesByClass() {
    const classId = document.getElementById('classFilter').value;
    if (classId) {
        fetch(`/api/grades/class/${classId}`)
            .then(response => response.json())
            .then(grades => {
                const formattedGrades = grades.map(grade => ({
                    id: grade.id,
                    studentId: grade.student.id,
                    studentName: grade.student.fullName,
                    className: grade.classEntity ? grade.classEntity.name : 'Chưa phân lớp',
                    subjectId: grade.subject.id,
                    subjectName: grade.subject.name,
                    grade15: grade.grade15,
                    gradeMidterm: grade.gradeMidterm,
                    gradeAttendance: grade.gradeAttendance,
                    gradeFinal: grade.gradeFinal,
                    averageGrade: grade.averageGrade,
                    gradeRank: grade.gradeRank
                }));
                displayGrades(formattedGrades);
            })
            .catch(error => {
                console.error('Lỗi khi tải điểm theo lớp:', error);
                displayGrades([]);
            });
    } else {
        // Nếu chưa chọn lớp, hiển thị tất cả để tránh cảm giác "không hiện"
        loadAllGrades();
    }
}

// Tải điểm theo môn học
function loadGradesBySubject() {
    const subjectId = document.getElementById('subjectFilter').value;
    if (subjectId) {
        fetch(`/api/grades/subject/${subjectId}`)
            .then(response => response.json())
            .then(grades => {
                const formattedGrades = grades.map(grade => ({
                    id: grade.id,
                    studentId: grade.student.id,
                    studentName: grade.student.fullName,
                    className: grade.classEntity ? grade.classEntity.name : 'Chưa phân lớp',
                    subjectId: grade.subject.id,
                    subjectName: grade.subject.name,
                    grade15: grade.grade15,
                    gradeMidterm: grade.gradeMidterm,
                    gradeAttendance: grade.gradeAttendance,
                    gradeFinal: grade.gradeFinal,
                    averageGrade: grade.averageGrade,
                    gradeRank: grade.gradeRank
                }));
                displayGrades(formattedGrades);
            })
            .catch(error => {
                console.error('Lỗi khi tải điểm theo môn học:', error);
                displayGrades([]);
            });
    } else {
        // Nếu chưa chọn môn, hiển thị tất cả
        loadAllGrades();
    }
}

// Tìm kiếm sinh viên
function searchStudents() {
    const searchTerm = document.getElementById('studentSearch').value.toLowerCase();
    if (searchTerm) {
        fetch(`/api/grades/search?keyword=${encodeURIComponent(searchTerm)}`)
            .then(response => response.json())
            .then(grades => {
                const formattedGrades = grades.map(grade => ({
                    id: grade.id,
                    studentId: grade.student.id,
                    studentName: grade.student.fullName,
                    className: grade.classEntity ? grade.classEntity.name : 'Chưa phân lớp',
                    subjectId: grade.subject.id,
                    subjectName: grade.subject.name,
                    grade15: grade.grade15,
                    gradeMidterm: grade.gradeMidterm,
                    gradeAttendance: grade.gradeAttendance,
                    gradeFinal: grade.gradeFinal,
                    averageGrade: grade.averageGrade,
                    gradeRank: grade.gradeRank
                }));
                displayGrades(formattedGrades);
            })
            .catch(error => {
                console.error('Lỗi khi tìm kiếm điểm:', error);
                displayGrades([]);
            });
    } else {
        // Không nhập gì thì hiển thị tất cả
        loadAllGrades();
    }
}

// Hiển thị bảng điểm
function displayGrades(grades) {
    const tbody = document.getElementById('gradesTableBody');

    if (grades.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="12" class="text-center text-muted py-4">
                    Không có dữ liệu điểm
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = '';
    grades.forEach((grade, index) => {
        // Sử dụng điểm trung bình và xếp hạng từ database nếu có
        const avgGrade10 = grade.averageGrade || calculateAverage(grade.grade15, grade.gradeMidterm, grade.gradeAttendance, grade.gradeFinal);
        const avgGrade4 = convertToGrade4(avgGrade10);
        const rank = grade.gradeRank || getGradeRank(avgGrade4);

        tbody.innerHTML += `
            <tr>
                <td>${index + 1}</td>
                <td>${grade.studentName}</td>
                <td>${grade.className}</td>
                <td>${grade.subjectName}</td>
                <td>${grade.grade15 || '--'}</td>
                <td>${grade.gradeMidterm || '--'}</td>
                <td>${grade.gradeAttendance || '--'}</td>
                <td>${grade.gradeFinal || '--'}</td>
                <td><strong>${avgGrade10.toFixed(2)}</strong></td>
                <td><strong>${avgGrade4.toFixed(2)}</strong></td>
                <td><span class="badge bg-${getRankColor(rank)}">${rank}</span></td>
                <td>
                    <button class="btn btn-sm btn-warning me-1" onclick="editGrade(${grade.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteGrade(${grade.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });

    updateGradeStatistics();
}

// Tính điểm trung bình
function calculateAverage(grade15, gradeMidterm, gradeAttendance, gradeFinal) {
    if (!grade15 || !gradeMidterm || !gradeAttendance || !gradeFinal) return 0;

    return (grade15 * gradeConfig.percent15 / 100) +
           (gradeMidterm * gradeConfig.percentMidterm / 100) +
           (gradeAttendance * gradeConfig.percentAttendance / 100) +
           (gradeFinal * gradeConfig.percentFinal / 100);
}

// Chuyển đổi sang thang điểm 4
function convertToGrade4(grade10) {
    if (grade10 >= 8.5) return 4.0;
    if (grade10 >= 7.0) return 3.0;
    if (grade10 >= 5.5) return 2.0;
    if (grade10 >= 4.0) return 1.0;
    return 0.0;
}

// Xếp hạng
function getGradeRank(grade4) {
    if (grade4 >= 3.6) return 'A';
    if (grade4 >= 3.0) return 'B';
    if (grade4 >= 2.0) return 'C';
    if (grade4 >= 1.0) return 'D';
    return 'F';
}

// Màu sắc cho rank
function getRankColor(rank) {
    const colors = {
        'A': 'primary',
        'B': 'success',
        'C': 'warning',
        'D': 'secondary',
        'F': 'danger'
    };
    return colors[rank] || 'secondary';
}

// Cập nhật thống kê
function updateGradeStatistics() {
    const currentGrades = document.querySelectorAll('#gradesTableBody tr');
    let stats = { A: 0, B: 0, C: 0, D: 0, F: 0 };

    currentGrades.forEach(row => {
        const rankCell = row.querySelector('.badge');
        if (rankCell) {
            const rank = rankCell.textContent.trim();
            if (stats.hasOwnProperty(rank)) {
                stats[rank]++;
            }
        }
    });

    document.getElementById('gradeA').textContent = stats.A;
    document.getElementById('gradeB').textContent = stats.B;
    document.getElementById('gradeC').textContent = stats.C;
    document.getElementById('gradeDandF').textContent = stats.D + stats.F;
}

// Thêm điểm mới
function addGrade() {
    document.getElementById('gradeModalTitle').textContent = 'Thêm điểm mới';
    document.getElementById('gradeForm').reset();
    document.getElementById('gradeId').value = '';

    const modal = new bootstrap.Modal(document.getElementById('gradeModal'));
    modal.show();
}

// Sửa điểm
function editGrade(gradeId) {
    // Tìm điểm trong database
    fetch(`/api/grades/detail/${gradeId}`)
        .then(response => response.json())
        .then(grade => {
            document.getElementById('gradeModalTitle').textContent = 'Chỉnh sửa điểm';
            document.getElementById('gradeId').value = grade.id;
            document.getElementById('studentSelect').value = grade.student.id;
            document.getElementById('subjectSelect').value = grade.subject.id;
            document.getElementById('grade15').value = grade.grade15 || '';
            document.getElementById('gradeMidterm').value = grade.gradeMidterm || '';
            document.getElementById('gradeAttendance').value = grade.gradeAttendance || '';
            document.getElementById('gradeFinal').value = grade.gradeFinal || '';

            calculateAverageGrade();

            const modal = new bootstrap.Modal(document.getElementById('gradeModal'));
            modal.show();
        })
        .catch(error => {
            console.error('Lỗi khi tải thông tin điểm:', error);
            alert('Không thể tải thông tin điểm để chỉnh sửa!');
        });
}

// Tính điểm trung bình trong modal
function calculateAverageGrade() {
    const grade15 = parseFloat(document.getElementById('grade15').value) || 0;
    const gradeMidterm = parseFloat(document.getElementById('gradeMidterm').value) || 0;
    const gradeAttendance = parseFloat(document.getElementById('gradeAttendance').value) || 0;
    const gradeFinal = parseFloat(document.getElementById('gradeFinal').value) || 0;

    const avg10 = calculateAverage(grade15, gradeMidterm, gradeAttendance, gradeFinal);
    const avg4 = convertToGrade4(avg10);
    const rank = getGradeRank(avg4);

    document.getElementById('averageGrade10').value = avg10.toFixed(2);
    document.getElementById('averageGrade4').value = avg4.toFixed(2);
    document.getElementById('gradeRank').value = rank;
}

// Lưu điểm
function saveGrade() {
    const gradeId = document.getElementById('gradeId').value;
    const studentId = parseInt(document.getElementById('studentSelect').value);
    const subjectId = parseInt(document.getElementById('subjectSelect').value);
    const grade15 = parseFloat(document.getElementById('grade15').value);
    const gradeMidterm = parseFloat(document.getElementById('gradeMidterm').value);
    const gradeAttendance = parseFloat(document.getElementById('gradeAttendance').value);
    const gradeFinal = parseFloat(document.getElementById('gradeFinal').value);

    if (!studentId || !subjectId) {
        alert('Vui lòng chọn sinh viên và môn học!');
        return;
    }

    const formData = new FormData();
    formData.append('studentId', studentId);
    formData.append('subjectId', subjectId);
    if (grade15) formData.append('grade15', grade15);
    if (gradeMidterm) formData.append('gradeMidterm', gradeMidterm);
    if (gradeAttendance) formData.append('gradeAttendance', gradeAttendance);
    if (gradeFinal) formData.append('gradeFinal', gradeFinal);
    formData.append('semester', 'Học kỳ 1');
    formData.append('academicYear', '2024-2025');

    const url = gradeId ? `/api/grades/${gradeId}` : '/api/grades';
    const method = gradeId ? 'PUT' : 'POST';

    fetch(url, {
        method: method,
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            // Đóng modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('gradeModal'));
            modal.hide();
            
            // Refresh dữ liệu
            const currentClass = document.getElementById('classFilter').value;
            const currentSubject = document.getElementById('subjectFilter').value;
            if (currentClass) {
                loadGradesByClass();
            } else if (currentSubject) {
                loadGradesBySubject();
            } else {
                loadAllGrades();
            }
        } else {
            alert('Lỗi: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Lỗi khi lưu điểm:', error);
        alert('Có lỗi xảy ra khi lưu điểm!');
    });
}

// Xóa điểm
function deleteGrade(gradeId) {
    if (confirm('Bạn có chắc chắn muốn xóa điểm này?')) {
        fetch(`/api/grades/${gradeId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                // Refresh dữ liệu
                const currentClass = document.getElementById('classFilter').value;
                const currentSubject = document.getElementById('subjectFilter').value;
                if (currentClass) {
                    loadGradesByClass();
                } else if (currentSubject) {
                    loadGradesBySubject();
                } else {
                    loadAllGrades();
                }
            } else {
                alert('Lỗi: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Lỗi khi xóa điểm:', error);
            alert('Có lỗi xảy ra khi xóa điểm!');
        });
    }
}

// Cập nhật input tỷ lệ
function updatePercentageInputs() {
    document.getElementById('percent15Input').addEventListener('input', calculateTotalPercent);
    document.getElementById('percentMidtermInput').addEventListener('input', calculateTotalPercent);
    document.getElementById('percentAttendanceInput').addEventListener('input', calculateTotalPercent);
    document.getElementById('percentFinalInput').addEventListener('input', calculateTotalPercent);
}

// Tính tổng tỷ lệ
function calculateTotalPercent() {
    const percent15 = parseInt(document.getElementById('percent15Input').value) || 0;
    const percentMidterm = parseInt(document.getElementById('percentMidtermInput').value) || 0;
    const percentAttendance = parseInt(document.getElementById('percentAttendanceInput').value) || 0;
    const percentFinal = parseInt(document.getElementById('percentFinalInput').value) || 0;

    const total = percent15 + percentMidterm + percentAttendance + percentFinal;
    document.getElementById('totalPercent').textContent = total + '%';

    if (total !== 100) {
        document.getElementById('totalPercent').style.color = 'red';
    } else {
        document.getElementById('totalPercent').style.color = 'green';
    }
}

// Lưu cấu hình tỷ lệ
function saveGradeConfig() {
    const percent15 = parseInt(document.getElementById('percent15Input').value) || 0;
    const percentMidterm = parseInt(document.getElementById('percentMidtermInput').value) || 0;
    const percentAttendance = parseInt(document.getElementById('percentAttendanceInput').value) || 0;
    const percentFinal = parseInt(document.getElementById('percentFinalInput').value) || 0;

    if (percent15 + percentMidterm + percentAttendance + percentFinal !== 100) {
        alert('Tổng tỷ lệ phải bằng 100%!');
        return;
    }

    gradeConfig = {
        percent15: percent15,
        percentMidterm: percentMidterm,
        percentAttendance: percentAttendance,
        percentFinal: percentFinal
    };

    // Cập nhật hiển thị
    document.getElementById('percent15').textContent = percent15 + '%';
    document.getElementById('percentMidterm').textContent = percentMidterm + '%';
    document.getElementById('percentAttendance').textContent = percentAttendance + '%';
    document.getElementById('percentFinal').textContent = percentFinal + '%';

    // Cập nhật header bảng
    const headers = document.querySelectorAll('#gradesTable thead tr:last-child th');
    if (headers.length >= 8) {
        headers[4].textContent = `15 phút (${percent15}%)`;
        headers[5].textContent = `Giữa kỳ (${percentMidterm}%)`;
        headers[6].textContent = `Chuyên cần (${percentAttendance}%)`;
        headers[7].textContent = `Cuối kỳ (${percentFinal}%)`;
    }

    // Đóng modal bằng cách sử dụng Bootstrap API
    const modalElement = document.getElementById('configGradeModal');
    if (modalElement) {
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
            modal.hide();
        } else {
            // Fallback: tạo instance mới nếu chưa có
            const newModal = new bootstrap.Modal(modalElement);
            newModal.hide();
        }
    }

    // Refresh bảng để tính lại điểm
    loadGradesByClass();

    // Hiển thị thông báo thành công
    showNotification('Cập nhật cấu hình tỷ lệ điểm thành công!', 'success');
}

// Hàm hiển thị thông báo
function showNotification(message, type = 'info') {
    // Tạo thông báo Bootstrap
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Tự động ẩn sau 3 giây
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 3000);
}

// Xuất Excel
function exportGrades() {
    alert('Chức năng xuất Excel sẽ được triển khai sau!');
}

// ...existing code...
</script>
</body>
</html>
